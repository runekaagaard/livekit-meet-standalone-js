!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";function u(e,s,a,c){return new(a=a||Promise)(function(n,t){function i(e){try{o(c.next(e))}catch(e){t(e)}}function r(e){try{o(c.throw(e))}catch(e){t(e)}}function o(e){var t;e.done?n(e.value):((t=e.value)instanceof a?t:new a(function(e){e(t)})).then(i,r)}o((c=c.apply(e,s||[])).next())})}var e={exports:{}},t=(r=function(){var i=function(){},d="undefined",r=typeof window!==d&&typeof window.navigator!==d&&/Trident\/|MSIE /.test(window.navigator.userAgent),u=["trace","debug","info","warn","error"],l={},y=null;function o(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function s(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function p(){for(var e=this.getLevel(),t=0;t<u.length;t++){var n=u[t];this[n]=t<e?i:this.methodFactory(n,e,this.name)}if(this.log=this.debug,typeof console===d&&e<this.levels.SILENT)return"No console available for logging"}function h(e,t,n){return"debug"===(e=e)&&(e="log"),typeof console!==d&&("trace"===e&&r?s:void 0!==console[e]?o(console,e):void 0!==console.log?o(console,"log"):i)||function(e){return function(){typeof console!==d&&(p.call(this),this[e].apply(this,arguments))}}.apply(this,arguments)}function t(e,t){var n,i,r=this,o="loglevel";function s(){var e;if(typeof window!==d&&o){try{e=window.localStorage[o]}catch(e){}if(typeof e===d)try{var t=window.document.cookie,n=encodeURIComponent(o),i=t.indexOf(n+"=");-1!==i&&(e=/^([^;]+)/.exec(t.slice(i+n.length+1))[1])}catch(e){}return e=void 0===r.levels[e]?void 0:e}}function a(e){var t=e;if("number"==typeof(t="string"==typeof t&&void 0!==r.levels[t.toUpperCase()]?r.levels[t.toUpperCase()]:t)&&0<=t&&t<=r.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?o+=":"+e:"symbol"==typeof e&&(o=void 0),r.name=e,r.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},r.methodFactory=t||h,r.getLevel=function(){return null!=i?i:null!=n?n:c},r.setLevel=function(e,t){return i=a(e),!1!==t&&function(){var e=(u[i]||"silent").toUpperCase();if(typeof window!==d&&o){try{return window.localStorage[o]=e}catch(e){}try{window.document.cookie=encodeURIComponent(o)+"="+e+";"}catch(e){}}}(),p.call(r)},r.setDefaultLevel=function(e){n=a(e),s()||r.setLevel(e,!1)},r.resetLevel=function(){if(i=null,typeof window!==d&&o){try{window.localStorage.removeItem(o)}catch(e){}try{window.document.cookie=encodeURIComponent(o)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}p.call(r)},r.enableAll=function(e){r.setLevel(r.levels.TRACE,e)},r.disableAll=function(e){r.setLevel(r.levels.SILENT,e)},r.rebuild=function(){if(y!==r&&(c=a(y.getLevel())),p.call(r),y===r)for(var e in l)l[e].rebuild()};var c=a(y?y.getLevel():"WARN"),e=s();null!=e&&(i=a(e)),p.call(r)}(y=new t).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");return l[e]||(l[e]=new t(e,y.methodFactory))};var e=typeof window!==d?window.log:void 0;return y.noConflict=function(){return typeof window!==d&&window.log===y&&(window.log=e),y},y.getLoggers=function(){return l},y.default=y},(a=e.exports)?e.exports=r():a.log=r(),e.exports);(a=p=p||{})[a.trace=0]="trace",a[a.debug=1]="debug",a[a.info=2]="info",a[a.warn=3]="warn",a[a.error=4]="error",a[a.silent=5]="silent",(r=I=I||{}).Default="livekit",r.Room="livekit-room",r.Participant="livekit-participant",r.Track="livekit-track",r.Publication="livekit-track-publication",r.Engine="livekit-engine",r.Signal="livekit-signal",r.PCManager="livekit-pc-manager",r.PCTransport="livekit-pc-transport",r.E2EE="lk-e2ee";let U=t.getLogger("livekit");Object.values(I).map(e=>t.getLogger(e)),U.setDefaultLevel(p.info);const h=t.getLogger("lk-e2ee");var i,n,f,s,l,r,o,a,N=Object.defineProperty,c=(e,t,n)=>((e,t,n)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n)(e,"symbol"!=typeof t?t+"":t,n);class M{constructor(){c(this,"_locking"),c(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return 0<this._locks}lock(){let t;this._locks+=1;const e=new Promise(e=>t=()=>{--this._locks,e()}),n=this._locking.then(()=>t);return this._locking=this._locking.then(()=>e),n}}(e=i=i||{})[e.WAITING=0]="WAITING",e[e.RUNNING=1]="RUNNING",e[e.COMPLETED=2]="COMPLETED";const v="AES-GCM",d={key:10,delta:3,audio:1,empty:0};class D extends Error{constructor(e,t){super(t||"an error has occured"),this.code=e}}(a=n=n||{}).PermissionDenied="PermissionDenied",a.NotFound="NotFound",a.DeviceInUse="DeviceInUse",a.Other="Other",(o=n=n||{}).getFailure=function(e){if(e&&"name"in e)return"NotFoundError"===e.name||"DevicesNotFoundError"===e.name?o.NotFound:"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?o.PermissionDenied:"NotReadableError"===e.name||"TrackStartError"===e.name?o.DeviceInUse:o.Other},(r=f=f||{})[r.InvalidKey=0]="InvalidKey",r[r.MissingKey=1]="MissingKey",r[r.InternalError=2]="InternalError";class g extends D{constructor(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:f.InternalError,n=2<arguments.length?arguments[2]:void 0;super(40,e),this.reason=t,this.participantIdentity=n}}(s=s||{}).KeyRatcheted="keyRatcheted",(l=l||{}).Error="cryptorError";var m,y,p,w={exports:{}},I=function(){if(m)return w.exports;m=1;var e="object"==typeof Reflect?Reflect:null,c=e&&"function"==typeof e.apply?e.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)},t=e&&"function"==typeof e.ownKeys?e.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)},n=Number.isNaN||function(e){return e!=e};function i(){i.init.call(this)}w.exports=i,w.exports.once=function(r,o){return new Promise(function(e,t){function n(e){r.removeListener(o,i),t(e)}function i(){"function"==typeof r.removeListener&&r.removeListener("error",n),e([].slice.call(arguments))}p(r,o,i,{once:!0}),"error"!==o&&"function"==typeof r.on&&p(r,"error",n,{once:!0})})},(i.EventEmitter=i).prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var r=10;function d(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function s(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function o(e,t,n,i){var r,o;return d(n),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,n.listener||n),r=e._events),o=r[t]),void 0===o?(o=r[t]=n,++e._eventsCount):("function"==typeof o?o=r[t]=i?[n,o]:[o,n]:i?o.unshift(n):o.push(n),0<(r=s(e))&&o.length>r&&!o.warned&&(o.warned=!0,(i=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit")).name="MaxListenersExceededWarning",i.emitter=e,i.type=t,i.count=o.length,console&&console.warn&&console.warn(i))),e}function a(e,t,n){e={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},t=function(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}.bind(e);return t.listener=n,e.wrapFn=t}function u(e,t,n){e=e._events;if(void 0===e)return[];e=e[t];{if(void 0===e)return[];if("function"==typeof e)return n?[e.listener||e]:[e];if(n){for(var i=e,r=new Array(i.length),o=0;o<r.length;++o)r[o]=i[o].listener||i[o];return r}return y(e,e.length)}}function l(e){var t=this._events;if(void 0!==t){t=t[e];if("function"==typeof t)return 1;if(void 0!==t)return t.length}return 0}function y(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}function p(n,i,r,o){if("function"==typeof n.on)o.once?n.once(i,r):n.on(i,r);else{if("function"!=typeof n.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n);n.addEventListener(i,function e(t){o.once&&n.removeEventListener(i,e),r(t)})}}return Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return r},set:function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");r=e}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||n(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return s(this)},i.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i="error"===e,r=this._events;if(void 0!==r)i=i&&void 0===r.error;else if(!i)return!1;if(i){if((o=0<t.length?t[0]:o)instanceof Error)throw o;i=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw i.context=o,i}var o=r[e];if(void 0===o)return!1;if("function"==typeof o)c(o,this,t);else for(var s=o.length,a=y(o,s),n=0;n<s;++n)c(a[n],this,t);return!0},i.prototype.on=i.prototype.addListener=function(e,t){return o(this,e,t,!1)},i.prototype.prependListener=function(e,t){return o(this,e,t,!0)},i.prototype.once=function(e,t){return d(t),this.on(e,a(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){return d(t),this.prependListener(e,a(this,e,t)),this},i.prototype.off=i.prototype.removeListener=function(e,t){var n,i,r,o,s;if(d(t),void 0===(i=this._events))return this;if(void 0===(n=i[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,o=n.length-1;0<=o;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,r=o;break}if(r<0)return this;if(0===r)n.shift();else{var a=n;var c=r;for(;c+1<a.length;c++)a[c]=a[c+1];a.pop()}1===n.length&&(i[e]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",e,s||t)}return this},i.prototype.removeAllListeners=function(e){var t,n;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){for(var i,r=Object.keys(n),o=0;o<r.length;++o)"removeListener"!==(i=r[o])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(o=t.length-1;0<=o;o--)this.removeListener(e,t[o]);return this},i.prototype.listeners=function(e){return u(this,e,!0)},i.prototype.rawListeners=function(e){return u(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):l.call(e,t)},i.prototype.listenerCount=l,i.prototype.eventNames=function(){return 0<this._eventsCount?t(this._events):[]},w.exports}();function b(e,t){var n=(new TextEncoder).encode(t);switch(e){case"HKDF":return{name:"HKDF",salt:n,hash:"SHA-256",info:new ArrayBuffer(128)};case"PBKDF2":return{name:"PBKDF2",salt:n,hash:"SHA-256",iterations:1e5};default:throw new Error("algorithm ".concat(e," is currently unsupported"))}}function k(t,n){return u(this,void 0,void 0,function*(){var e=b(t.algorithm.name,n),e=yield crypto.subtle.deriveKey(e,t,{name:v,length:128},!1,["encrypt","decrypt"]);return{material:t,encryptionKey:e}})}class j{constructor(){this.consecutiveSifCount=0,this.lastSifReceivedAt=0,this.userFramesSinceSif=0}recordSif(){this.consecutiveSifCount+=1,null==this.sifSequenceStartedAt&&(this.sifSequenceStartedAt=Date.now()),this.lastSifReceivedAt=Date.now()}recordUserFrame(){void 0!==this.sifSequenceStartedAt&&(this.userFramesSinceSif+=1,(this.userFramesSinceSif>this.consecutiveSifCount||2e3<Date.now()-this.lastSifReceivedAt)&&this.reset())}isSifAllowed(){return this.consecutiveSifCount<100&&(void 0===this.sifSequenceStartedAt||Date.now()-this.sifSequenceStartedAt<2e3)}reset(){this.userFramesSinceSif=0,this.consecutiveSifCount=0,this.sifSequenceStartedAt=void 0}}const S=new Map;class B extends I.EventEmitter{encodeFunction(e,t){throw Error("not implemented for subclass")}decodeFunction(e,t){throw Error("not implemented for subclass")}}class q extends B{constructor(e){super(),this.sendCounts=new Map,this.keys=e.keys,this.participantIdentity=e.participantIdentity,this.rtpMap=new Map,this.keyProviderOptions=e.keyProviderOptions,this.sifTrailer=null!=(e=e.sifTrailer)?e:Uint8Array.from([]),this.sifGuard=new j}get logContext(){return{participant:this.participantIdentity,mediaTrackId:this.trackId,fallbackCodec:this.videoCodec}}setParticipant(e,t){h.debug("setting new participant on cryptor",Object.assign(Object.assign({},this.logContext),{participant:e})),this.participantIdentity&&h.error("cryptor has already a participant set, participant should have been unset before",Object.assign({},this.logContext)),this.participantIdentity=e,this.keys=t,this.sifGuard.reset()}unsetParticipant(){h.debug("unsetting participant",this.logContext),this.participantIdentity=void 0}isEnabled(){return this.participantIdentity?S.get(this.participantIdentity):void 0}getParticipantIdentity(){return this.participantIdentity}getTrackId(){return this.trackId}setVideoCodec(e){this.videoCodec=e}setRtpMap(e){this.rtpMap=e}setupTransform(e,t,n,i,r){r&&(h.info("setting codec on cryptor to",{codec:r}),this.videoCodec=r),h.debug("Setting up frame cryptor transform",Object.assign({operation:e,passedTrackId:i,codec:r},this.logContext));const o="encode"===e?this.encodeFunction:this.decodeFunction,s=new TransformStream({transform:o.bind(this)});t.pipeThrough(s).pipeTo(n).catch(e=>{h.warn(e),this.emit(l.Error,e instanceof g?e:new g(e.message,void 0,this.participantIdentity))}),this.trackId=i}setSifTrailer(e){h.debug("setting SIF trailer",Object.assign(Object.assign({},this.logContext),{trailer:e})),this.sifTrailer=e}encodeFunction(c,d){return u(this,void 0,void 0,function*(){var t;if(!this.isEnabled()||0===c.data.byteLength)return d.enqueue(c);const n=this.keys.getKeySet();if(n){var i=n["encryptionKey"],e=this.keys.getCurrentKeyIndex();if(i){const n=this.makeIV(null!=(t=c.getMetadata().synchronizationSource)?t:-1,c.timestamp);var r=this.getUnencryptedBytes(c);const s=new Uint8Array(c.data,0,r.unencryptedBytes),a=new Uint8Array(2);a[0]=12,a[1]=e;try{const t=yield crypto.subtle.encrypt({name:v,iv:n,additionalData:new Uint8Array(c.data,0,s.byteLength)},i,new Uint8Array(c.data,r.unencryptedBytes));let e=new Uint8Array(t.byteLength+n.byteLength+a.byteLength);e.set(new Uint8Array(t)),e.set(new Uint8Array(n),t.byteLength),e.set(a,t.byteLength+n.byteLength),r.isH264&&(e=function(e){const t=[];for(var n=0,i=0;i<e.length;++i){var r=e[i];r<=3&&2<=n&&(t.push(3),n=0),t.push(r),0==r?++n:n=0}return new Uint8Array(t)}(e));var o=new Uint8Array(s.byteLength+e.byteLength);return o.set(s),o.set(e,s.byteLength),c.data=o.buffer,d.enqueue(c)}catch(t){h.error(t)}}else h.debug("failed to encrypt, emitting error",this.logContext),this.emit(l.Error,new g("encryption key missing for encoding",f.MissingKey,this.participantIdentity))}else this.emit(l.Error,new g("key set not found for ".concat(this.participantIdentity," at index ").concat(this.keys.getCurrentKeyIndex()),f.MissingKey,this.participantIdentity))})}decodeFunction(n,i){return u(this,void 0,void 0,function*(){if(!this.isEnabled()||0===n.data.byteLength)return h.debug("skipping empty frame",this.logContext),this.sifGuard.recordUserFrame(),i.enqueue(n);if(function(e,t){if(0!==t.byteLength){const n=new Uint8Array(e.slice(e.byteLength-t.byteLength));return t.every((e,t)=>e===n[t])}}(n.data,this.sifTrailer))return h.debug("enqueue SIF",this.logContext),this.sifGuard.recordSif(),this.sifGuard.isSifAllowed()?(n.data=n.data.slice(0,n.data.byteLength-this.sifTrailer.byteLength),i.enqueue(n)):void h.warn("SIF limit reached, dropping frame");this.sifGuard.recordUserFrame();var t=new Uint8Array(n.data)[n.data.byteLength-1];if(!this.keys.hasInvalidKeyAtIndex(t))if(this.keys.getKeySet(t))try{var e=yield this.decryptFrame(n,t);if(this.keys.decryptionSuccess(t),e)return i.enqueue(e)}catch(e){e instanceof g&&e.reason===f.InvalidKey?this.keys.hasValidKey&&(this.emit(l.Error,e),this.keys.decryptionFailure(t)):h.warn("decoding frame failed",{error:e})}else h.warn("skipping decryption due to missing key at index ".concat(t)),this.emit(l.Error,new g("missing key at index ".concat(t," for participant ").concat(this.participantIdentity),f.MissingKey,this.participantIdentity)),this.keys.decryptionFailure(t)})}decryptFrame(e,t){return u(this,arguments,void 0,function(d,u){var l=this;let y=2<arguments.length&&void 0!==arguments[2]?arguments[2]:void 0,p=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{ratchetCount:0};return function*(){var e,t=l.keys.getKeySet(u);if(!p.encryptionKey&&!t)throw new TypeError("no encryption key found for decryption of ".concat(l.participantIdentity));let n=l.getUnencryptedBytes(d);try{const u=new Uint8Array(d.data,0,n.unencryptedBytes);var i=new Uint8Array(d.data,u.length,d.data.byteLength-u.length);if(n.isH264&&function(e){for(var t=0;t<e.length-3;t++)if(0==e[t]&&0==e[t+1]&&3==e[t+2])return 1}(i)){i=function(e){const t=[];for(var n=e.length,i=0;i<e.length;)3<=n-i&&!e[i]&&!e[i+1]&&3==e[i+2]?(t.push(e[i++]),t.push(e[i++]),i++):t.push(e[i++]);return new Uint8Array(t)}(i);const l=new Uint8Array(u.byteLength+i.byteLength);l.set(u),l.set(i,u.byteLength),d.data=l.buffer}const l=new Uint8Array(d.data,d.data.byteLength-2,2),y=l[0],r=new Uint8Array(d.data,d.data.byteLength-y-l.byteLength,y),h=u.byteLength,o=d.data.byteLength-(u.byteLength+y+l.byteLength),s=yield crypto.subtle.decrypt({name:v,iv:r,additionalData:new Uint8Array(d.data,0,u.byteLength)},null!=(e=p.encryptionKey)?e:t.encryptionKey,new Uint8Array(d.data,h,o)),a=new ArrayBuffer(u.byteLength+s.byteLength),c=new Uint8Array(a);return c.set(new Uint8Array(d.data,0,u.byteLength)),c.set(new Uint8Array(s),u.byteLength),d.data=a,d}catch(e){if(0<l.keyProviderOptions.ratchetWindowSize){if(p.ratchetCount<l.keyProviderOptions.ratchetWindowSize){let e;if(h.debug("ratcheting key attempt ".concat(p.ratchetCount," of ").concat(l.keyProviderOptions.ratchetWindowSize,", for kind ").concat(d instanceof RTCEncodedAudioFrame?"audio":"video")),(null!=y?y:t)===l.keys.getKeySet(u)){const d=yield l.keys.ratchetKey(u,!1);e=yield k(d,l.keyProviderOptions.ratchetSalt)}const n=yield l.decryptFrame(d,u,y||t,{ratchetCount:p.ratchetCount+1,encryptionKey:null==e?void 0:e.encryptionKey});return n&&e&&(null!=y?y:t)===l.keys.getKeySet(u)&&(l.keys.setKeySet(e,u,!0),l.keys.setCurrentKeyIndex(u)),n}throw h.warn("maximum ratchet attempts exceeded"),new g("valid key missing for participant ".concat(l.participantIdentity),f.InvalidKey,l.participantIdentity)}throw new g("Decryption failed: ".concat(e.message),f.InvalidKey,l.participantIdentity)}}()})}makeIV(e,t){const n=new ArrayBuffer(12),i=new DataView(n);this.sendCounts.has(e)||this.sendCounts.set(e,Math.floor(65535*Math.random()));var r=null!=(r=this.sendCounts.get(e))?r:0;return i.setUint32(0,e),i.setUint32(4,t),i.setUint32(8,t-r%65535),this.sendCounts.set(e,r+1),n}getUnencryptedBytes(e){var t={unencryptedBytes:0,isH264:!1};if("type"in e){var n=null!=(n=this.getVideoCodec(e))?n:this.videoCodec;if(n!==this.detectedCodec&&(h.debug("detected different codec",Object.assign({detectedCodec:n,oldCodec:this.detectedCodec},this.logContext)),this.detectedCodec=n),"av1"===n)throw new Error("".concat(n," is not yet supported for end to end encryption"));if("vp8"===n)t.unencryptedBytes=d[e.type];else if("vp9"===n)return t.unencryptedBytes=0,t;const i=new Uint8Array(e.data);try{const e=function(t){const n=[];let i=0,r=0,o=t.length-2;for(;r<o;){for(;r<o&&(0!==t[r]||0!==t[r+1]||1!==t[r+2]);)r++;let e=r=r>=o?t.length:r;for(;e>i&&0===t[e-1];)e--;if(0===i){if(e!==i)throw TypeError("byte stream contains leading data")}else n.push(i);i=r+=3}return n}(i);if(t.isH264="h264"===n||e.some(e=>[y.SLICE_IDR,y.SLICE_NON_IDR].includes(L(i[e]))),t.isH264){for(const n of e)switch(L(i[n])){case y.SLICE_IDR:case y.SLICE_NON_IDR:return t.unencryptedBytes=n+2,t}throw new TypeError("Could not find NALU")}}catch(e){}return t.unencryptedBytes=d[e.type],t}return t.unencryptedBytes=d.audio,t}getVideoCodec(e){if(0!==this.rtpMap.size)return e=e.getMetadata().payloadType,e?this.rtpMap.get(e):void 0}}function L(e){return e&G}const G=31;(p=y=y||{})[p.SLICE_NON_IDR=1]="SLICE_NON_IDR",p[p.SLICE_PARTITION_A=2]="SLICE_PARTITION_A",p[p.SLICE_PARTITION_B=3]="SLICE_PARTITION_B",p[p.SLICE_PARTITION_C=4]="SLICE_PARTITION_C",p[p.SLICE_IDR=5]="SLICE_IDR",p[p.SEI=6]="SEI",p[p.SPS=7]="SPS",p[p.PPS=8]="PPS",p[p.AUD=9]="AUD",p[p.END_SEQ=10]="END_SEQ",p[p.END_STREAM=11]="END_STREAM",p[p.FILLER_DATA=12]="FILLER_DATA",p[p.SPS_EXT=13]="SPS_EXT",p[p.PREFIX_NALU=14]="PREFIX_NALU",p[p.SUBSET_SPS=15]="SUBSET_SPS",p[p.DPS=16]="DPS",p[p.SLICE_AUX=19]="SLICE_AUX",p[p.SLICE_EXT=20]="SLICE_EXT",p[p.SLICE_LAYER_EXT=21]="SLICE_LAYER_EXT";class E extends I.EventEmitter{get hasValidKey(){return!this.hasInvalidKeyAtIndex(this.currentKeyIndex)}constructor(e,t){if(super(),this.currentKeyIndex=0,t.keyringSize<1||256<t.keyringSize)throw new TypeError("Keyring size needs to be between 1 and 256");this.cryptoKeyRing=new Array(t.keyringSize).fill(void 0),this.decryptionFailureCounts=new Array(t.keyringSize).fill(0),this.keyProviderOptions=t,this.ratchetPromiseMap=new Map,this.participantIdentity=e}hasInvalidKeyAtIndex(e){return 0<=this.keyProviderOptions.failureTolerance&&this.decryptionFailureCounts[e]>this.keyProviderOptions.failureTolerance}decryptionFailure(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.currentKeyIndex;this.keyProviderOptions.failureTolerance<0||(this.decryptionFailureCounts[e]+=1,this.decryptionFailureCounts[e]>this.keyProviderOptions.failureTolerance&&h.warn("key for ".concat(this.participantIdentity," at index ").concat(e," is being marked as invalid")))}decryptionSuccess(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.currentKeyIndex;this.resetKeyStatus(e)}resetKeyStatus(e){void 0===e?this.decryptionFailureCounts.fill(0):this.decryptionFailureCounts[e]=0}ratchetKey(e){let r=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];const o=null!=e?e:this.getCurrentKeyIndex(),t=this.ratchetPromiseMap.get(o);if(void 0!==t)return t;e=new Promise((n,i)=>u(this,void 0,void 0,function*(){try{const i=this.getKeySet(o);if(!i)throw new TypeError("Cannot ratchet key without a valid keyset of participant ".concat(this.participantIdentity));var e=i.material,t=yield function(){return u(this,arguments,void 0,function(e){let t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{name:v},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"encrypt";return function*(){return crypto.subtle.importKey("raw",e,t,!1,"derive"===n?["deriveBits","deriveKey"]:["encrypt","decrypt"])}()})}(yield function(t,n){return u(this,void 0,void 0,function*(){var e=b(t.algorithm.name,n);return crypto.subtle.deriveBits(e,t,256)})}(e,this.keyProviderOptions.ratchetSalt),e.algorithm.name,"derive");r&&(yield this.setKeyFromMaterial(t,o,!0),this.emit(s.KeyRatcheted,t,this.participantIdentity,o)),n(t)}catch(e){i(e)}finally{this.ratchetPromiseMap.delete(o)}}));return this.ratchetPromiseMap.set(o,e),e}setKey(e){return u(this,arguments,void 0,function(e){var t=this;let n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;return function*(){yield t.setKeyFromMaterial(e,n),t.resetKeyStatus(n)}()})}setKeyFromMaterial(e,t){return u(this,arguments,void 0,function(n,i){var r=this;let o=2<arguments.length&&void 0!==arguments[2]&&arguments[2];return function*(){var e=yield k(n,r.keyProviderOptions.ratchetSalt),t=0<=i?i%r.cryptoKeyRing.length:r.currentKeyIndex;h.debug("setting new key with index ".concat(i),{usage:n.usages,algorithm:n.algorithm,ratchetSalt:r.keyProviderOptions.ratchetSalt}),r.setKeySet(e,t,o),0<=t&&(r.currentKeyIndex=t)}()})}setKeySet(e,t){var n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];this.cryptoKeyRing[t%this.cryptoKeyRing.length]=e,n&&this.emit(s.KeyRatcheted,e.material,this.participantIdentity,t)}setCurrentKeyIndex(e){return u(this,void 0,void 0,function*(){this.currentKeyIndex=e%this.cryptoKeyRing.length,this.resetKeyStatus(e)})}getCurrentKeyIndex(){return this.currentKeyIndex}getKeySet(e){return this.cryptoKeyRing[null!=e?e:this.currentKeyIndex]}}const C=[],T=new Map;let A,K,z=new class{constructor(){this.pendingTasks=new Map,this.taskMutex=new M,this.nextTaskIndex=0}run(n){return u(this,void 0,void 0,function*(){const e={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:i.WAITING},t=(this.pendingTasks.set(e.id,e),yield this.taskMutex.lock());try{return e.executedAt=Date.now(),e.status=i.RUNNING,yield n()}finally{e.status=i.COMPLETED,this.pendingTasks.delete(e.id),t()}})}flush(){return u(this,void 0,void 0,function*(){return this.run(()=>u(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}},_=!1,x={sharedKey:!1,ratchetSalt:"LKFrameEncryptionKey",ratchetWindowSize:8,failureTolerance:10,keyringSize:16},P=new Map;function R(e,t){let n=C.filter(e=>e.getTrackId()===t);if(1<n.length){const i=n.map(e=>({participant:e.getParticipantIdentity()})).join(",");h.error("Found multiple cryptors for the same trackID ".concat(t,". target participant: ").concat(e," "),{participants:i})}let i=n[0];if(i)e!==i.getParticipantIdentity()&&i.setParticipant(e,O(e));else{if(h.info("creating new cryptor for",{participantIdentity:e}),!x)throw Error("Missing keyProvider options");(i=new q({participantIdentity:e,keys:O(e),keyProviderOptions:x,sifTrailer:K})).setRtpMap(P),i.on(l.Error,e=>{e={kind:"error",data:{error:new Error("".concat(f[e.reason],": ").concat(e.message))}};postMessage(e)}),C.push(i)}return i}function O(e){if(_)return F();let t=T.get(e);return t||((t=new E(e,x)).on(s.KeyRatcheted,W),T.set(e,t)),t}function F(){return A||(h.debug("creating new shared key handler"),A=new E("shared-key",x)),A}function W(e,t,n){postMessage({kind:"ratchetKey",data:{participantIdentity:t,keyIndex:n,material:e}})}h.setDefaultLevel("info"),onmessage=c=>{z.run(()=>u(void 0,void 0,void 0,function*(){const{kind:e,data:t}=c.data;switch(e){case"init":h.setLevel(t.loglevel),h.info("worker initialized"),x=t.keyProviderOptions,_=!!t.keyProviderOptions.sharedKey,postMessage({kind:"initAck",data:{enabled:!1}});break;case"enable":o=t.enabled,s=t.participantIdentity,h.debug("setting encryption enabled for all tracks of ".concat(s),{enable:o}),S.set(s,o),h.info("updated e2ee enabled status for ".concat(t.participantIdentity," to ").concat(t.enabled)),postMessage(c.data);break;case"decode":case"encode":R(t.participantIdentity,t.trackId).setupTransform(e,t.readableStream,t.writableStream,t.trackId,t.codec);break;case"setKey":_?yield function(e,t){return u(this,void 0,void 0,function*(){h.info("set shared key",{index:t}),yield F().setKey(e,t)})}(t.key,t.keyIndex):t.participantIdentity?(h.info("set participant sender key ".concat(t.participantIdentity," index ").concat(t.keyIndex)),yield O(t.participantIdentity).setKey(t.key,t.keyIndex)):h.error("no participant Id was provided and shared key usage is disabled");break;case"removeTransform":{var n=t.trackId;var i=t.participantIdentity;s=C.filter(e=>e.getParticipantIdentity()===i&&e.getTrackId()===n);1<s.length&&h.error("Found multiple cryptors for the same participant and trackID combination",{trackId:n,participantIdentity:i});const a=s[0];a?a.unsetParticipant():h.warn("Could not unset participant on cryptor",{trackId:n,participantIdentity:i})}break;case"updateCodec":R(t.participantIdentity,t.trackId).setVideoCodec(t.codec);break;case"setRTPMap":P=t.map,C.forEach(e=>{e.getParticipantIdentity()===t.participantIdentity&&e.setRtpMap(t.map)});break;case"ratchetRequest":!function(n){u(this,void 0,void 0,function*(){if(_){const e=F();yield e.ratchetKey(n.keyIndex),e.resetKeyStatus()}else if(n.participantIdentity){const t=O(n.participantIdentity);yield t.ratchetKey(n.keyIndex),t.resetKeyStatus()}else h.error("no participant Id was provided for ratchet request and shared key usage is disabled")})}(t);break;case"setSifTrailer":r=t.trailer,K=r,C.forEach(e=>{e.setSifTrailer(r)})}var r,o,s}))},self.RTCTransformEvent&&(h.debug("setup transform event"),self.onrtctransform=e=>{const t=e.transformer,{kind:n,participantIdentity:i,trackId:r,codec:o}=(h.debug("transformer",t),t.handled=!0,t.options),s=R(i,r);h.debug("transform",{codec:o}),s.setupTransform(n,t.readable,t.writable,r,o)})});